<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sims4Translatorå¯¾å¿œJSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç½®æ›ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            background-color: #f0f8ff;
            color: #1a202c;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem;
            padding: 2.5rem;
            max-width: 1000px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .header { text-align: center; margin-bottom: 2.5rem; }
        .header h1 { font-size: 2rem; font-weight: 700; color: #2b6cb0; margin-bottom: 0.75rem; line-height: 1.2; }
        .header p { color: #4a5568; font-size: 1.125rem; line-height: 1.6; }
        .header p a { color: #2b6cb0; font-weight: 700; text-decoration: underline; transition: color 0.3s ease; }
        .file-upload-label {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: #ebf8ff; color: #2c5282; padding: 3rem; border-radius: 1.5rem;
            cursor: pointer; font-weight: 600; transition: all 0.18s ease; border: 2px dashed #90cdf4;
            text-align: center;
        }
        .file-upload-label:hover { background-color: #e2f2ff; border-color: #63b3ed; transform: translateY(-2px); }
        .file-upload-label svg { width: 4rem; height: 4rem; margin-bottom: 1.5rem; color: #63b3ed; }
        input[type="file"] { display: none; }
        #file-name { text-align: center; margin-top: 1rem; color: #718096; min-height: 1.5rem; font-weight: 600; }
        .btn-process {
            background: linear-gradient(45deg, #68d391, #38a169); color: white; padding: 1rem;
            border-radius: 0.75rem; font-weight: 700; font-size: 1.125rem; width: 100%; margin-top: 2.5rem;
            transition: all 0.18s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: none;
        }
        .btn-process:disabled { background: #cbd5e0; cursor: not-allowed; box-shadow: none; }
        .message-box { margin-top: 1.5rem; padding: 1rem; border-radius: 0.75rem; font-weight: 600; text-align: center;
            display: none; opacity: 0; transform: translateY(-10px); animation: fadeIn 0.5s ease forwards;
        }
        .message-box.info { background-color: #b3e6ff; color: #2c5282; }
        .message-box.success { background-color: #9ae6b4; color: #2f855a; }
        .message-box.error { background-color: #fed7d7; color: #c53030; }
        .download-buttons {
            display: flex;
            gap: 1.5rem;
            margin-top: 2.5rem;
            width: 100%;
            flex-direction: row;
        }
        .btn-download {
            flex: 1;
            background: linear-gradient(45deg, #f6ad55, #ed8936); color: white; padding: 1rem 2rem; font-weight: 600;
            font-size: 1rem; border-radius: 0.75rem; text-align: center; text-decoration: none; transition: all 0.18s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; align-items: center; justify-content: center;
        }
        .btn-download svg { margin-right: 0.5rem; width: 1.25rem; height: 1.25rem; }
        .info-section { margin-top: 3rem; padding: 2.5rem; background-color: #ffffff; border-radius: 1.5rem; max-width: 1000px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .info-section h3 { font-weight: 700; font-size: 1.5rem; color: #2d3748; margin-bottom: 1rem; }
        .info-section li { margin-bottom: 0.5rem; }
        .warning-box { background-color: #fed7d7; color: #c53030; padding: 1.25rem; border-radius: 0.75rem; font-weight: 600; margin-top: 1.5rem; text-align: center; line-height: 1.5; }
        .footer { margin-top: 3rem; text-align: center; font-size: 0.875rem; color: #718096; }
        .footer-links { display: flex; flex-direction: column; align-items: flex-start; gap: 0.5rem; margin-top: 1rem; text-align: left; }
        .footer-links ul { list-style: none; padding: 0; margin: 0; }
        .footer-links li a { color: #2b6cb0; font-weight: 700; text-decoration: underline; transition: color 0.3s ease; }
        .info-section a { color: #2b6cb0; font-weight: 700; text-decoration: underline; transition: color 0.3s ease; }
        .dragover { border-color: #4299e1 !important; background-color: #e6f7ff !important; transform: translateY(-2px); }
        .preview-container {
            margin-top: 2.5rem;
            display: none;
            gap: 1.5rem;
            flex-direction: row;
        }
        .preview-pane {
            flex: 1;
            padding: 1.5rem;
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            overflow-x: auto;
            position: relative;
        }
        .preview-pane h4 { font-weight: 700; font-size: 1.1rem; color: #4a5568; margin-bottom: 1rem; }
        .preview-pane pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
            color: #2d3748;
            max-height: 500px;
        }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Sims4Translatorå¯¾å¿œJSONãƒ•ã‚¡ã‚¤ãƒ«<br>ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç½®æ›ãƒ„ãƒ¼ãƒ«</h1>
        <p>
            ã“ã®ãƒ„ãƒ¼ãƒ«ã¯TheSims4Translatorç”¨ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯<a href="https://stbl.sims4toolkit.com/" target="_blank" rel="noopener noreferrer">STBL Studio</a>ã‚„The-Sims-4-MOD-JSON-ã‹ã‚‰ä¸»åŠ›ã•ã‚Œã‚‹STBL JSONãƒ•ã‚¡ã‚¤ãƒ«ã® <code>{M0.he}</code>ã€<code>{F0.she}</code> ãªã©ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ <code>{M0.å½¼}</code>ã€<code>{F0.å½¼å¥³}</code> ã«å¤‰æ›ã—ã¾ã™ã€‚<br>
            ç¿»è¨³æ©Ÿèƒ½ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ç¿»è¨³ã¯åˆ¥ãƒ„ãƒ¼ãƒ«ã‚’ã”åˆ©ç”¨ãã ã•ã„ï¼š<br>
            <a href="https://nonamesims4.github.io/TheSims4Translator-JSON-/" target="_blank" rel="noopener noreferrer">The Sims 4 Translator å°‚ç”¨JSONå¤‰æ›ãƒ„ãƒ¼ãƒ«</a><br>
            <a href="https://github.com/nonamesims4/The-Sims-4-MOD-JSON-" target="_blank" rel="noopener noreferrer">The-Sims-4-MOD-JSON-</a>
        </p>
    </div>
    <label for="file-upload" class="file-upload-label" id="file-upload-area" role="button" aria-label="JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm1 14h-2v-4H8l4-4 4 4h-3v4z"/></svg>
        <span class="text-xl font-semibold">Sims4Translatorç”¨JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</span>
        <input id="file-upload" type="file" accept=".json" />
    </label>
    <div id="file-name">ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
    <button id="process-button" class="btn-process" disabled>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†</button>
    <div id="message-box" class="message-box" role="status" aria-live="polite"></div>
    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="preview-container" class="preview-container">
        <div class="preview-pane">
            <h4>å¤‰æ›å‰ã®JSON</h4>
            <pre id="original-preview">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ä¸‹ã•ã„...</pre>
        </div>
        <div class="preview-pane">
            <h4>å¤‰æ›å¾Œã®JSON</h4>
            <pre id="processed-preview">å‡¦ç†å¾Œã«ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</pre>
        </div>
    </div>
    <div class="download-buttons">
        <a id="download-translator" class="btn-download" download>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 14h-2v-4H8l4-4 4 4h-3v4z"/></svg>
            Sims4Translatorç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </a>
        <a id="download-normal" class="btn-download" download>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 14h-2v-4H8l4-4 4 4h-3v4z"/></svg>
            æ™®é€šJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </a>
    </div>
    <div class="warning-box">
        âš ï¸ ä½¿ç”¨ä¸Šã®æ³¨æ„âš ï¸<br>
        Sims4Translatorã«èª­ã¿è¾¼ã¾ã›ã‚‹éš›ã¯ã€å¿…ãšã€ŒSims4Translatorç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã§ä¿å­˜ã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚<br>
        STBL JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãæ›ãˆãŸå ´åˆã¯ã€STBL JSONå½¢å¼ã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚<br>
        The Sims 4 Translatorç”¨ã§ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€åˆ¥é€”ã€ŒThe Sims 4 Translatorå°‚ç”¨JSONå¤‰æ›ãƒ„ãƒ¼ãƒ«ã€ã§å¤‰æ›ã—ã¦ãã ã•ã„ã€‚
    </div>
</div>
<div class="info-section">
    <h3>ãƒ„ãƒ¼ãƒ«ã®ä¸»ãªæ©Ÿèƒ½</h3>
    <ul>
        <li>
            <strong>ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰:</strong> ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã§JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã§ãã¾ã™ã€‚
        </li>
        <li>
            <strong>ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®è‡ªå‹•ç½®æ›:</strong> <code>{M0.he}</code> ã‚„ <code>{F0.she}</code> ãªã©ã®è‹±èªãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ã€<code>{M0.å½¼}</code> ã‚„ <code>{F0.å½¼å¥³}</code> ã¨ã„ã£ãŸæ—¥æœ¬èªè¡¨è¨˜ã«è‡ªå‹•ã§å¤‰æ›ã—ã¾ã™ã€‚
        </li>
        <li>
            <strong>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºæ©Ÿèƒ½:</strong> å‡¦ç†å‰ã¨å‡¦ç†å¾Œã®JSONã®å†…å®¹ã‚’å·¦å³ã«ä¸¦ã¹ã¦è¡¨ç¤ºã™ã‚‹ã“ã¨ã§ã€å¤‰æ›´å†…å®¹ã‚’ã²ã¨ç›®ã§ç¢ºèªã§ãã¾ã™ã€‚
        </li>
        <li>
            <strong>ç½®æ›æ•°ã®è¡¨ç¤º:</strong> å‡¦ç†å®Œäº†æ™‚ã«ã€ã„ãã¤ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒç½®æ›ã•ã‚ŒãŸã‹ã‚’æ­£ç¢ºã«è¡¨ç¤ºã—ã¾ã™ã€‚
        </li>
        <li>
            <strong>ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¸ã®å¯¾å¿œ:</strong> JSONã® <code>Value</code> ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚„é…åˆ—ã«ãªã£ã¦ã„ã‚‹å ´åˆã§ã‚‚ã€ãã®ä¸­ã®æ–‡å­—åˆ—ã‚’å†å¸°çš„ã«æ¢ã—å‡ºã—ã¦ç½®æ›ã—ã¾ã™ã€‚
        </li>
    </ul>
    <h3>ã•ã‚‰ã«ç¿»è¨³ã‚’ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ã—ãŸã„æ–¹ã¸</h3>
    <p>
        æœ¬ãƒ„ãƒ¼ãƒ«ã®ã‚ã¨ã€ã‚ˆã‚Šè‡ªç„¶ãªæ—¥æœ¬èªè¡¨ç¾ã«ä»•ä¸Šã’ãŸã„å ´åˆã¯ã€
        <a href="https://nonamesims4.github.io/Sims4JSON-AI-/" target="_blank" rel="noopener noreferrer">Sims4JSONãƒ•ã‚¡ã‚¤ãƒ«å°‚ç”¨ AIä¾é ¼æ–‡ä»˜ããƒªãƒˆãƒ©ã‚¤ãƒ„ãƒ¼ãƒ«âœ¨</a>ã‚‚ãœã²ãŠè©¦ã—ãã ã•ã„ã€‚<br>
        AIã‚’æ´»ç”¨ã—ãŸãƒªãƒ©ã‚¤ãƒˆã‚„ã‚¿ã‚°ã®é«˜åº¦ç½®æ›ãŒå¯èƒ½ã§ã™ã€‚
    </p>
</div>
<div class="footer">
    <h3>ğŸ›  ä»–ãƒ„ãƒ¼ãƒ«ã®ã”æ¡ˆå†…</h3>
    <p>æœ¬ãƒ„ãƒ¼ãƒ«ã¨ã‚ã‚ã›ã¦ã€ä»¥ä¸‹ã®é–¢é€£ãƒ„ãƒ¼ãƒ«ã‚‚ã”æ´»ç”¨ãã ã•ã„ã€‚ï¼ˆã™ã¹ã¦åˆ¥çª“ã§é–‹ãã¾ã™ï¼‰</p>
    <div class="footer-links">
        <ul>
            <li>ğŸŒŸ <a href="https://nonamesims4.github.io/TheSims4Translator-JSON-/" target="_blank" rel="noopener noreferrer">The Sims 4 Translator å°‚ç”¨ JSONå¤‰æ›ãƒ„ãƒ¼ãƒ«</a></li>
            <li>ğŸŒŸ <a href="https://github.com/nonamesims4" target="_blank" rel="noopener noreferrer">nonamesims4 GitHubãƒªãƒã‚¸ãƒˆãƒªä¸€è¦§</a></li>
            <li>ğŸŒŸ <a href="https://www.patreon.com/posts/da-shitawu-yi-135996994" target="_blank" rel="noopener noreferrer">ä¾¿åˆ©ãƒ„ãƒ¼ãƒ«ç°¡æ˜“ã¾ã¨ã‚ (Patreon)</a></li>
            <li>ğŸŒŸ <a href="https://www.perplexity.ai/" target="_blank" rel="noopener noreferrer">ã“ã®ãƒšãƒ¼ã‚¸ã®ã‚³ãƒ¼ãƒ‰ä½œæˆï¼ˆPerplexity AIï¼‰</a></li>
            <li>ğŸŒŸ <a href="https://gemini.google.com/app" target="_blank" rel="noopener noreferrer">ã“ã®ãƒšãƒ¼ã‚¸ã®ä½œæˆï¼ˆGeminiï¼‰</a></li>
            <li>ğŸŒŸ <a href="https://chatgpt.com/?model=auto" target="_blank" rel="noopener noreferrer">ã“ã®ãƒšãƒ¼ã‚¸ã®ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆChatGPTï¼‰</a></li>
            <li><!-- ã“ã“ã«è¿½åŠ ã®ãƒªãƒ³ã‚¯ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ --></li>
        </ul>
    </div>
</div>
<script>
    const fileUpload = document.getElementById('file-upload');
    const fileNameEl = document.getElementById('file-name');
    const processBtn = document.getElementById('process-button');
    const messageBox = document.getElementById('message-box');
    const dlTranslator = document.getElementById('download-translator');
    const dlNormal = document.getElementById('download-normal');
    const fileUploadArea = document.getElementById('file-upload-area');
    const previewContainer = document.getElementById('preview-container');
    const originalPreview = document.getElementById('original-preview');
    const processedPreview = document.getElementById('processed-preview');
    let uploadedData = null;
    let uploadedFileName = 'output';
    let processedTranslator = null;
    let processedNormal = null;
    let lastTranslatorURL = null;
    let lastNormalURL = null;

    // ç½®æ›è¾æ›¸ï¼ˆã‚­ãƒ¼ã¯å¤§æ–‡å­—ã§è¡¨ç¾ï¼‰
    const replaceDict = {
        '{M0.HE}': '{M0.å½¼}',
        '{M0.HIS}': '{M0.å½¼}',
        "{M0.HE'S}": "{M0.å½¼}",
        '{F0.SHE}': '{F0.å½¼å¥³}',
        '{F0.HER}': '{F0.å½¼å¥³}',
        "{F0.SHE'S}": "{F0.å½¼å¥³}",
        '{M1.HE}': '{M1.å½¼}',
        '{M1.HIS}': '{M1.å½¼}',
        '{F1.SHE}': '{F1.å½¼å¥³}',
        '{F1.HER}': '{F1.å½¼å¥³}',
        '{0.SIMFIRSTNAME}': '{0.SimFirstName}',
        '{1.SIMFIRSTNAME}': '{1.SimFirstName}',
        '__PH_0__': '{0.SimFirstName}',
        '__PH_1__': '{1.SimFirstName}',
        '__ph_0__': '{0.SimFirstName}',
        '__ph_1__': '{1.SimFirstName}',
        // æ–°ã—ã„ç½®æ›ãƒ«ãƒ¼ãƒ«
        '{0.SIMPRONOUNSUBJECTIVE}': '{M0.å½¼}{F0.å½¼å¥³}',
        '{0.SIMPRONOUNPOSSESSIVEDEPENDENT}': '{M0.å½¼}{F0.å½¼å¥³}',
        '{0.SIMPRONOUNREFLEXIVE}': '{M0.å½¼}{F0.å½¼å¥³}',
        '{0.SIMPRONOUNOBJECTIVE}': '{M0.å½¼}{F0.å½¼å¥³}',
        '{F0.å½¼å¥³ã®}': '{F0.å½¼å¥³}',
    };

    // æ—¥æœ¬èªã®åŠ©è©ãªã©ã®ç½®æ›ãƒ«ãƒ¼ãƒ«ï¼ˆå¾Œæ–¹å‚ç…§ã‚’ä½¿ã„ã€ã‚ˆã‚ŠæŸ”è»Ÿã«å¯¾å¿œï¼‰
    const regexRules = [
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¿½åŠ ã‚’å¸Œæœ›ã—ãŸãƒ«ãƒ¼ãƒ«
        { pattern: /\{M0\.å½¼\}\s*\{F0\.å½¼å¥³ã®\}/gi, replacement: '{M0.å½¼}{F0.å½¼å¥³ã®}' },
        { pattern: /\{M0\.å½¼ã®\}\s*\{F0\.å½¼å¥³\}/gi, replacement: '{M0.å½¼ã®}{F0.å½¼å¥³}' },
        // é€£ç¶šã™ã‚‹åŒã˜ã‚¿ã‚°ã®é™¤å»
        { pattern: /\{F0\.å½¼å¥³ã®\}\s*\{F0\.å½¼å¥³\}/gi, replacement: '{F0.å½¼å¥³}' },
        { pattern: /\{F0\.å½¼å¥³\}\s*\{F0\.å½¼å¥³ã®\}/gi, replacement: '{F0.å½¼å¥³}' },
        { pattern: /\{M0\.å½¼ã®\}\s*\{M0\.å½¼\}/gi, replacement: '{M0.å½¼}' },
        { pattern: /\{M0\.å½¼\}\s*\{M0\.å½¼ã®\}/gi, replacement: '{M0.å½¼}' },
        // æ—¥æœ¬èªã®åŠ©è©ãªã©ã®é™¤å»
        { pattern: /(\{F0\.å½¼å¥³ã®\})ã®/g, replacement: '$1' },
        { pattern: /(\{M0\.å½¼ã®\})ã®/g, replacement: '$1' },
        { pattern: /(\{F0\.å½¼å¥³ã«\})ã«/g, replacement: '$1' },
        { pattern: /(\{M0\.å½¼ã«\})ã«/g, replacement: '$1' },
        { pattern: /(\{F0\.å½¼å¥³ãŒ\})ãŒ/g, replacement: '$1' },
        { pattern: /(\{M0\.å½¼ãŒ\})ãŒ/g, replacement: '$1' },
        { pattern: /(\{F0\.å½¼å¥³ã¯\})ã¯/g, replacement: '$1' },
        { pattern: /(\{M0\.å½¼ã¯\})ã¯/g, replacement: '$1' },
        { pattern: /(\{F0\.å½¼å¥³ã‚’\})ã‚’/g, replacement: '$1' },
        { pattern: /(\{M0\.å½¼ã‚’\})ã‚’/g, replacement: '$1' },
        { pattern: /(\{F0\.å½¼å¥³ã¨\})ã¨/g, replacement: '$1' },
        { pattern: /(\{M0\.å½¼ã¨\})ã¨/g, replacement: '$1' },
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¿½åŠ ã‚’å¸Œæœ›ã—ãŸãƒ«ãƒ¼ãƒ«ï¼ˆå‰å›ã¾ã§ï¼‰
        { pattern: /\{F0\.å½¼å¥³ã®\}\s*\{F0\.å½¼å¥³\}ã¯/gi, replacement: '{F0.å½¼å¥³}' },
        { pattern: /\{M0\.å½¼ã®\}\s*\{M0\.å½¼\}ã¯/gi, replacement: '{M0.å½¼}' },
    ];

    // ç¾åœ¨ã®å‡¦ç†ã§ã®ç½®æ›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    let replacementsCount = 0;
    function showMessage(text, type = 'info') {
        messageBox.textContent = text;
        messageBox.className = `message-box ${type}`;
        messageBox.style.display = 'block';
    }
    function escapeRegExp(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    /**
     * æ–‡å­—åˆ—ä¸­ã®ã‚¿ã‚°ã‚’æ­£è¦åŒ–ãƒ»ç½®æ›ã™ã‚‹é–¢æ•°
     * - {} å†…ã®è‹±æ•°å­—ã‚¿ã‚°ã‚’å¤§æ–‡å­—åŒ–ã—ã¦ã‹ã‚‰è¾æ›¸ã§ç½®æ›ï¼ˆè¾æ›¸ã¯å¤§æ–‡å­—ã‚­ãƒ¼ï¼‰
     * - å‰å¾Œã®ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã‚’å‰Šé™¤ï¼ˆä¾‹: "*text*" ã®ä½™åˆ†ãª * ã‚’å–ã‚Šé™¤ãï¼‰
     * - ç½®æ›å›æ•°ã‚’ replacementsCount ã«åŠ ç®—
     */
    function normalizeTags(text) {
        if (typeof text !== 'string') return text;
        let processedText = text;
        // {} å†…ã®ã‚¿ã‚°ã‚’å¤§æ–‡å­—åŒ–ï¼ˆè‹±æ•°å­—ãƒ»._'- ã®ã¿ã‚’å¯¾è±¡ï¼‰
        processedText = processedText.replace(/\{[0-9a-zA-Z\._'\-]+\}/g, m => m.toUpperCase());
        // å‰å¾Œã®ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã‚’å‰Šé™¤ï¼ˆå¿…è¦ãªã‚‰èª¿æ•´ï¼‰
        processedText = processedText.replace(/^\*\s*/, '').replace(/\s*\*\s*$/, '');
        // è¾æ›¸ç½®æ›
        for (const key in replaceDict) {
            const pattern = new RegExp(escapeRegExp(key), 'gi');
            const newText = processedText.replace(pattern, (match) => {
                replacementsCount++;
                return replaceDict[key];
            });
            if (newText !== processedText) {
                processedText = newText;
            }
        }
        // æ­£è¦è¡¨ç¾ç½®æ›
        for (const rule of regexRules) {
            const newText = processedText.replace(rule.pattern, (match) => {
                // å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
                if (match !== rule.replacement) {
                    replacementsCount++;
                }
                return rule.replacement;
            });
            if (newText !== processedText) {
                processedText = newText;
            }
        }
        return processedText;
    }

    /**
     * ä»»æ„ã®å€¤ï¼ˆæ–‡å­—åˆ—ãƒ»é…åˆ—ãƒ»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã‚’å†å¸°çš„ã«å‡¦ç†ã™ã‚‹
     * æ–‡å­—åˆ—ã¯ normalizeTags ã«æ¸¡ã™
     */
    function deepProcess(value) {
        if (typeof value === 'string') {
            return normalizeTags(value);
        }
        if (Array.isArray(value)) {
            return value.map(v => deepProcess(v));
        }
        if (value && typeof value === 'object') {
            // æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹ï¼ˆä¸å¤‰æ€§ã‚’ä¿ã¤ï¼‰
            const out = Array.isArray(value) ? [] : {};
            for (const k in value) {
                if (Object.prototype.hasOwnProperty.call(value, k)) {
                    out[k] = deepProcess(value[k]);
                }
            }
            return out;
        }
        return value;
    }

    function resetUI() {
        fileNameEl.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“';
        processBtn.disabled = true;
        messageBox.style.display = 'none';
        dlTranslator.style.display = 'none';
        dlNormal.style.display = 'none';
        uploadedData = null;
        processedTranslator = null;
        processedNormal = null;
        uploadedFileName = 'output';
        // revoke previous URLs just in case
        if (lastTranslatorURL) {
            URL.revokeObjectURL(lastTranslatorURL);
            lastTranslatorURL = null;
        }
        if (lastNormalURL) {
            URL.revokeObjectURL(lastNormalURL);
            lastNormalURL = null;
        }
        originalPreview.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ä¸‹ã•ã„...';
        processedPreview.textContent = 'å‡¦ç†å¾Œã«ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
        previewContainer.style.display = 'none';
    }
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
    fileUpload.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) {
            resetUI();
            return;
        }
        uploadedFileName = (file.name || 'output').replace(/\.json$/i, '') || 'output';
        fileNameEl.textContent = file.name;
        processBtn.disabled = false;
        messageBox.style.display = 'none';
        const reader = new FileReader();
        reader.onload = evt => {
            try {
                uploadedData = JSON.parse(evt.target.result);
                originalPreview.textContent = JSON.stringify(uploadedData, null, 2);
                previewContainer.style.display = 'flex';
                showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚å‡¦ç†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'info');
            } catch (err) {
                uploadedData = null;
                processBtn.disabled = true;
                showMessage('JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ­£ã—ã„JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                console.error(err);
            }
        };
        reader.readAsText(file);
    });
    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileUploadArea.addEventListener(eventName, preventDefaults, false);
    });
    fileUploadArea.addEventListener('dragenter', () => fileUploadArea.classList.add('dragover'), false);
    fileUploadArea.addEventListener('dragleave', () => fileUploadArea.classList.remove('dragover'), false);
    fileUploadArea.addEventListener('drop', handleDrop, false);
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    function handleDrop(e) {
        fileUploadArea.classList.remove('dragover');
        const dt = e.dataTransfer;
        if (!dt || !dt.files || !dt.files[0]) return;
        const file = dt.files[0];
        // ãƒ‡ãƒ¼ã‚¿ã‚’ file input ã«ã‚»ãƒƒãƒˆã—ã¦ change ã‚’ç™ºç«
        fileUpload.files = dt.files;
        fileUpload.dispatchEvent(new Event('change'));
    }
    // å¤‰æ›å‡¦ç†
    processBtn.addEventListener('click', () => {
        if (!uploadedData) {
            showMessage('å…ˆã«JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚', 'error');
            return;
        }
        processBtn.disabled = true;
        showMessage('å‡¦ç†ä¸­...', 'info');
        // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦UIãŒæ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
        setTimeout(() => {
            try {
                // deep copy
                const dataCopy = JSON.parse(JSON.stringify(uploadedData));
                // reset counter
                replacementsCount = 0;
                const hasLocale = dataCopy.Locale !== undefined || dataCopy.locale !== undefined;
                const entriesKey = dataCopy.Entries ? 'Entries' : (dataCopy.entries ? 'entries' : null);
                const entries = entriesKey ? dataCopy[entriesKey] : null;
                if (hasLocale && Array.isArray(entries)) {
                    // Sims4Translator å½¢å¼ï¼ˆ{ Locale, Entries: [{ Key, Value }, ...] }ï¼‰
                    const replacedEntries = entries.map(entry => {
                        const origKey = entry.Key || entry.key || '';
                        const processedKey = (origKey || '').toUpperCase();
                        const rawValue = entry.Value !== undefined ? entry.Value : entry.value;
                        return {
                            Key: processedKey,
                            Value: deepProcess(rawValue === undefined ? '' : rawValue)
                        };
                    });
                    processedTranslator = { Locale: dataCopy.Locale || dataCopy.locale || 'JPN_JP', Entries: replacedEntries };
                    processedNormal = replacedEntries.map(e => ({ key: e.Key.toLowerCase(), value: e.Value }));
                } else if (Array.isArray(dataCopy)) {
                    // é€šå¸¸ã®JSONé…åˆ—å½¢å¼ [{ Key/ key, Value / value }, ...]
                    processedTranslator = null;
                    processedNormal = dataCopy.map(entry => {
                        const origKey = entry.Key || entry.key || '';
                        const rawValue = entry.Value !== undefined ? entry.Value : entry.value;
                        return { key: (origKey || '').toLowerCase(), value: deepProcess(rawValue === undefined ? '' : rawValue) };
                    });
                } else if (dataCopy && typeof dataCopy === 'object' && Object.keys(dataCopy).length > 0 && Array.isArray(dataCopy.Entries ?? dataCopy.entries)) {
                    // å¿µã®ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    const arr = dataCopy.Entries ?? dataCopy.entries;
                    const replacedEntries = arr.map(entry => {
                        const origKey = entry.Key || entry.key || '';
                        const rawValue = entry.Value !== undefined ? entry.Value : entry.value;
                        return {
                            Key: (origKey || '').toUpperCase(),
                            Value: deepProcess(rawValue === undefined ? '' : rawValue)
                        };
                    });
                    processedTranslator = { Locale: dataCopy.Locale || dataCopy.locale || 'JPN_JP', Entries: replacedEntries };
                    processedNormal = replacedEntries.map(e => ({ key: e.Key.toLowerCase(), value: e.Value }));
                } else {
                    throw new Error('éå¯¾å¿œã®JSONå½¢å¼ã§ã™ã€‚é…åˆ—ã¾ãŸã¯ { Locale, Entries } å½¢å¼ã®ã„ãšã‚Œã‹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚');
                }
                // download ç”¨ Blob ã‚’ä½œæˆã—ã€ä»¥å‰ã® URL ã‚’ç ´æ£„
                if (lastTranslatorURL) { URL.revokeObjectURL(lastTranslatorURL); lastTranslatorURL = null; }
                if (lastNormalURL) { URL.revokeObjectURL(lastNormalURL); lastNormalURL = null; }
                if (processedTranslator) {
                    const blobT = new Blob([JSON.stringify(processedTranslator, null, 2)], { type: 'application/json' });
                    lastTranslatorURL = URL.createObjectURL(blobT);
                    dlTranslator.href = lastTranslatorURL;
                    dlTranslator.download = `${uploadedFileName}-translator.json`;
                    dlTranslator.style.display = 'flex';
                } else {
                    dlTranslator.style.display = 'none';
                }
                if (processedNormal) {
                    const blobN = new Blob([JSON.stringify(processedNormal, null, 2)], { type: 'application/json' });
                    lastNormalURL = URL.createObjectURL(blobN);
                    dlNormal.href = lastNormalURL;
                    dlNormal.download = `${uploadedFileName}-normal.json`;
                    dlNormal.style.display = 'flex';
                } else {
                    dlNormal.style.display = 'none';
                }
                processedPreview.textContent = JSON.stringify(processedTranslator || processedNormal, null, 2);
                showMessage(`å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ç½®æ›ç®‡æ‰€: ${replacementsCount} ç®‡æ‰€ã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‹ã‚‰ä¿å­˜ã§ãã¾ã™ã€‚`, 'success');
            } catch (err) {
                console.error(err);
                showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (err && err.message ? err.message : String(err)), 'error');
                dlTranslator.style.display = 'none';
                dlNormal.style.display = 'none';
            } finally {
                processBtn.disabled = false;
            }
        }, 80);
    });
    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ä½œæˆã—ãŸ ObjectURL ã‚’ç ´æ£„
    window.addEventListener('unload', () => {
        if (lastTranslatorURL) URL.revokeObjectURL(lastTranslatorURL);
        if (lastNormalURL) URL.revokeObjectURL(lastNormalURL);
    });
</script>
</body>
</html>
