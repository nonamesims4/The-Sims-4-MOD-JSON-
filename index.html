<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sims4Translator対応JSONファイルプレースホルダー置換ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            background-color: #f0f8ff;
            color: #1a202c;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem;
            padding: 2.5rem;
            max-width: 1000px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .header { text-align: center; margin-bottom: 2.5rem; }
        .header h1 { font-size: 2rem; font-weight: 700; color: #2b6cb0; margin-bottom: 0.75rem; line-height: 1.2; }
        .header p { color: #4a5568; font-size: 1.125rem; line-height: 1.6; }
        .header p a { color: #2b6cb0; font-weight: 700; text-decoration: underline; transition: color 0.3s ease; }
        .file-upload-label {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: #ebf8ff; color: #2c5282; padding: 3rem; border-radius: 1.5rem;
            cursor: pointer; font-weight: 600; transition: all 0.18s ease; border: 2px dashed #90cdf4;
            text-align: center;
        }
        .file-upload-label:hover { background-color: #e2f2ff; border-color: #63b3ed; transform: translateY(-2px); }
        .file-upload-label svg { width: 4rem; height: 4rem; margin-bottom: 1.5rem; color: #63b3ed; }
        input[type="file"] { display: none; }
        #file-name { text-align: center; margin-top: 1rem; color: #718096; min-height: 1.5rem; font-weight: 600; }
        .btn-process {
            background: linear-gradient(45deg, #68d391, #38a169); color: white; padding: 1rem;
            border-radius: 0.75rem; font-weight: 700; font-size: 1.125rem; width: 100%; margin-top: 2.5rem;
            transition: all 0.18s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: none;
        }
        .btn-process:disabled { background: #cbd5e0; cursor: not-allowed; box-shadow: none; }
        .message-box { margin-top: 1.5rem; padding: 1rem; border-radius: 0.75rem; font-weight: 600; text-align: center;
            display: none; opacity: 0; transform: translateY(-10px); animation: fadeIn 0.5s ease forwards;
        }
        .message-box.info { background-color: #b3e6ff; color: #2c5282; }
        .message-box.success { background-color: #9ae6b4; color: #2f855a; }
        .message-box.error { background-color: #fed7d7; color: #c53030; }
        .download-buttons {
            display: flex;
            gap: 1.5rem;
            margin-top: 2.5rem;
            width: 100%;
            flex-direction: row;
        }
        .btn-download {
            flex: 1;
            background: linear-gradient(45deg, #f6ad55, #ed8936); color: white; padding: 1rem 2rem; font-weight: 600;
            font-size: 1rem; border-radius: 0.75rem; text-align: center; text-decoration: none; transition: all 0.18s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; align-items: center; justify-content: center;
        }
        .btn-download svg { margin-right: 0.5rem; width: 1.25rem; height: 1.25rem; }
        .info-section { margin-top: 3rem; padding: 2.5rem; background-color: #ffffff; border-radius: 1.5rem; max-width: 1000px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .info-section h3 { font-weight: 700; font-size: 1.5rem; color: #2d3748; margin-bottom: 1rem; }
        .info-section li { margin-bottom: 0.5rem; }
        .warning-box { background-color: #fed7d7; color: #c53030; padding: 1.25rem; border-radius: 0.75rem; font-weight: 600; margin-top: 1.5rem; text-align: center; line-height: 1.5; }
        .footer { margin-top: 3rem; text-align: center; font-size: 0.875rem; color: #718096; }
        .footer-links { display: flex; flex-direction: column; align-items: flex-start; gap: 0.5rem; margin-top: 1rem; text-align: left; }
        .footer-links ul { list-style: none; padding: 0; margin: 0; }
        .footer-links li a { color: #2b6cb0; font-weight: 700; text-decoration: underline; transition: color 0.3s ease; }
        .info-section a { color: #2b6cb0; font-weight: 700; text-decoration: underline; transition: color 0.3s ease; }
        .dragover { border-color: #4299e1 !important; background-color: #e6f7ff !important; transform: translateY(-2px); }
        .preview-container {
            margin-top: 2.5rem;
            display: none;
            gap: 1.5rem;
            flex-direction: row;
        }
        .preview-pane {
            flex: 1;
            padding: 1.5rem;
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            overflow-x: auto;
            position: relative;
        }
        .preview-pane h4 { font-weight: 700; font-size: 1.1rem; color: #4a5568; margin-bottom: 1rem; }
        .preview-pane pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
            color: #2d3748;
            max-height: 500px;
        }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Sims4Translator対応JSONファイル<br>プレースホルダー置換ツール</h1>
        <p>
            このツールはTheSims4Translator用のJSONファイルまたは<a href="https://stbl.sims4toolkit.com/" target="_blank" rel="noopener noreferrer">STBL Studio</a>やThe-Sims-4-MOD-JSON-から主力されるSTBL JSONファイルの <code>{M0.he}</code>、<code>{F0.she}</code> などのプレースホルダーを <code>{M0.彼}</code>、<code>{F0.彼女}</code> に変換します。<br>
            翻訳機能はありません。翻訳は別ツールをご利用ください：<br>
            <a href="https://nonamesims4.github.io/TheSims4Translator-JSON-/" target="_blank" rel="noopener noreferrer">The Sims 4 Translator 専用JSON変換ツール</a><br>
            <a href="https://github.com/nonamesims4/The-Sims-4-MOD-JSON-" target="_blank" rel="noopener noreferrer">The-Sims-4-MOD-JSON-</a>
        </p>
    </div>
    <label for="file-upload" class="file-upload-label" id="file-upload-area" role="button" aria-label="JSONファイルを選択またはドラッグ＆ドロップ">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm1 14h-2v-4H8l4-4 4 4h-3v4z"/></svg>
        <span class="text-xl font-semibold">Sims4Translator用JSONファイルをここにドラッグ＆ドロップまたはクリックして選択</span>
        <input id="file-upload" type="file" accept=".json" />
    </label>
    <div id="file-name">ファイルが選択されていません</div>
    <button id="process-button" class="btn-process" disabled>ファイルを処理</button>
    <div id="message-box" class="message-box" role="status" aria-live="polite"></div>
    <!-- プレビュー表示エリア -->
    <div id="preview-container" class="preview-container">
        <div class="preview-pane">
            <h4>変換前のJSON</h4>
            <pre id="original-preview">ファイルを選択して下さい...</pre>
        </div>
        <div class="preview-pane">
            <h4>変換後のJSON</h4>
            <pre id="processed-preview">処理後にここに表示されます。</pre>
        </div>
    </div>
    <div class="download-buttons">
        <a id="download-translator" class="btn-download" download>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 14h-2v-4H8l4-4 4 4h-3v4z"/></svg>
            Sims4Translator用ファイルをダウンロード
        </a>
        <a id="download-normal" class="btn-download" download>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 14h-2v-4H8l4-4 4 4h-3v4z"/></svg>
            普通JSONファイルをダウンロード
        </a>
    </div>
    <div class="warning-box">
        ⚠️ 使用上の注意⚠️<br>
        Sims4Translatorに読み込ませる際は、必ず「Sims4Translator用ファイルをダウンロード」ボタンで保存したJSONファイルを使用してください。<br>
        STBL JSONファイルを置き換えた場合は、STBL JSON形式で出力されます。<br>
        The Sims 4 Translator用で使用する場合は、別途「The Sims 4 Translator専用JSON変換ツール」で変換してください。
    </div>
</div>
<div class="info-section">
    <h3>ツールの主な機能</h3>
    <ul>
        <li>
            <strong>ファイルのアップロード:</strong> ドラッグ＆ドロップまたはクリックでJSONファイルを選択できます。
        </li>
        <li>
            <strong>プレースホルダーの自動置換:</strong> <code>{M0.he}</code> や <code>{F0.she}</code> などの英語プレースホルダーを、<code>{M0.彼}</code> や <code>{F0.彼女}</code> といった日本語表記に自動で変換します。
        </li>
        <li>
            <strong>プレビュー表示機能:</strong> 処理前と処理後のJSONの内容を左右に並べて表示することで、変更内容をひと目で確認できます。
        </li>
        <li>
            <strong>置換数の表示:</strong> 処理完了時に、いくつのプレースホルダーが置換されたかを正確に表示します。
        </li>
        <li>
            <strong>ネストされたデータへの対応:</strong> JSONの <code>Value</code> がオブジェクトや配列になっている場合でも、その中の文字列を再帰的に探し出して置換します。
        </li>
    </ul>
    <h3>さらに翻訳をブラッシュアップしたい方へ</h3>
    <p>
        本ツールのあと、より自然な日本語表現に仕上げたい場合は、
        <a href="https://nonamesims4.github.io/Sims4JSON-AI-/" target="_blank" rel="noopener noreferrer">Sims4JSONファイル専用 AI依頼文付きリトライツール✨</a>もぜひお試しください。<br>
        AIを活用したリライトやタグの高度置換が可能です。
    </p>
</div>
<div class="footer">
    <h3>🛠 他ツールのご案内</h3>
    <p>本ツールとあわせて、以下の関連ツールもご活用ください。（すべて別窓で開きます）</p>
    <div class="footer-links">
        <ul>
            <li>🌟 <a href="https://nonamesims4.github.io/TheSims4Translator-JSON-/" target="_blank" rel="noopener noreferrer">The Sims 4 Translator 専用 JSON変換ツール</a></li>
            <li>🌟 <a href="https://github.com/nonamesims4" target="_blank" rel="noopener noreferrer">nonamesims4 GitHubリポジトリ一覧</a></li>
            <li>🌟 <a href="https://www.patreon.com/posts/da-shitawu-yi-135996994" target="_blank" rel="noopener noreferrer">便利ツール簡易まとめ (Patreon)</a></li>
            <li>🌟 <a href="https://www.perplexity.ai/" target="_blank" rel="noopener noreferrer">このページのコード作成（Perplexity AI）</a></li>
            <li>🌟 <a href="https://gemini.google.com/app" target="_blank" rel="noopener noreferrer">このページの作成（Gemini）</a></li>
            <li>🌟 <a href="https://chatgpt.com/?model=auto" target="_blank" rel="noopener noreferrer">このページのデザイン（ChatGPT）</a></li>
            <li><!-- ここに追加のリンクを追加してください --></li>
        </ul>
    </div>
</div>
<script>
    const fileUpload = document.getElementById('file-upload');
    const fileNameEl = document.getElementById('file-name');
    const processBtn = document.getElementById('process-button');
    const messageBox = document.getElementById('message-box');
    const dlTranslator = document.getElementById('download-translator');
    const dlNormal = document.getElementById('download-normal');
    const fileUploadArea = document.getElementById('file-upload-area');
    const previewContainer = document.getElementById('preview-container');
    const originalPreview = document.getElementById('original-preview');
    const processedPreview = document.getElementById('processed-preview');
    let uploadedData = null;
    let uploadedFileName = 'output';
    let processedTranslator = null;
    let processedNormal = null;
    let lastTranslatorURL = null;
    let lastNormalURL = null;

    // 置換辞書（キーは大文字で表現）
    const replaceDict = {
        '{M0.HE}': '{M0.彼}',
        '{M0.HIS}': '{M0.彼}',
        "{M0.HE'S}": "{M0.彼}",
        '{F0.SHE}': '{F0.彼女}',
        '{F0.HER}': '{F0.彼女}',
        "{F0.SHE'S}": "{F0.彼女}",
        '{M1.HE}': '{M1.彼}',
        '{M1.HIS}': '{M1.彼}',
        '{F1.SHE}': '{F1.彼女}',
        '{F1.HER}': '{F1.彼女}',
        '{0.SIMFIRSTNAME}': '{0.SimFirstName}',
        '{1.SIMFIRSTNAME}': '{1.SimFirstName}',
        '__PH_0__': '{0.SimFirstName}',
        '__PH_1__': '{1.SimFirstName}',
        '__ph_0__': '{0.SimFirstName}',
        '__ph_1__': '{1.SimFirstName}',
        // 新しい置換ルール
        '{0.SIMPRONOUNSUBJECTIVE}': '{M0.彼}{F0.彼女}',
        '{0.SIMPRONOUNPOSSESSIVEDEPENDENT}': '{M0.彼}{F0.彼女}',
        '{0.SIMPRONOUNREFLEXIVE}': '{M0.彼}{F0.彼女}',
        '{0.SIMPRONOUNOBJECTIVE}': '{M0.彼}{F0.彼女}',
        '{F0.彼女の}': '{F0.彼女}',
    };

    // 日本語の助詞などの置換ルール（後方参照を使い、より柔軟に対応）
    const regexRules = [
        // ユーザーが追加を希望したルール
        { pattern: /\{M0\.彼\}\s*\{F0\.彼女の\}/gi, replacement: '{M0.彼}{F0.彼女の}' },
        { pattern: /\{M0\.彼の\}\s*\{F0\.彼女\}/gi, replacement: '{M0.彼の}{F0.彼女}' },
        // 連続する同じタグの除去
        { pattern: /\{F0\.彼女の\}\s*\{F0\.彼女\}/gi, replacement: '{F0.彼女}' },
        { pattern: /\{F0\.彼女\}\s*\{F0\.彼女の\}/gi, replacement: '{F0.彼女}' },
        { pattern: /\{M0\.彼の\}\s*\{M0\.彼\}/gi, replacement: '{M0.彼}' },
        { pattern: /\{M0\.彼\}\s*\{M0\.彼の\}/gi, replacement: '{M0.彼}' },
        // 日本語の助詞などの除去
        { pattern: /(\{F0\.彼女の\})の/g, replacement: '$1' },
        { pattern: /(\{M0\.彼の\})の/g, replacement: '$1' },
        { pattern: /(\{F0\.彼女に\})に/g, replacement: '$1' },
        { pattern: /(\{M0\.彼に\})に/g, replacement: '$1' },
        { pattern: /(\{F0\.彼女が\})が/g, replacement: '$1' },
        { pattern: /(\{M0\.彼が\})が/g, replacement: '$1' },
        { pattern: /(\{F0\.彼女は\})は/g, replacement: '$1' },
        { pattern: /(\{M0\.彼は\})は/g, replacement: '$1' },
        { pattern: /(\{F0\.彼女を\})を/g, replacement: '$1' },
        { pattern: /(\{M0\.彼を\})を/g, replacement: '$1' },
        { pattern: /(\{F0\.彼女と\})と/g, replacement: '$1' },
        { pattern: /(\{M0\.彼と\})と/g, replacement: '$1' },
        // ユーザーが追加を希望したルール（前回まで）
        { pattern: /\{F0\.彼女の\}\s*\{F0\.彼女\}は/gi, replacement: '{F0.彼女}' },
        { pattern: /\{M0\.彼の\}\s*\{M0\.彼\}は/gi, replacement: '{M0.彼}' },
    ];

    // 現在の処理での置換数をカウント
    let replacementsCount = 0;
    function showMessage(text, type = 'info') {
        messageBox.textContent = text;
        messageBox.className = `message-box ${type}`;
        messageBox.style.display = 'block';
    }
    function escapeRegExp(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    /**
     * 文字列中のタグを正規化・置換する関数
     * - {} 内の英数字タグを大文字化してから辞書で置換（辞書は大文字キー）
     * - 前後のアスタリスクを削除（例: "*text*" の余分な * を取り除く）
     * - 置換回数を replacementsCount に加算
     */
    function normalizeTags(text) {
        if (typeof text !== 'string') return text;
        let processedText = text;
        // {} 内のタグを大文字化（英数字・._'- のみを対象）
        processedText = processedText.replace(/\{[0-9a-zA-Z\._'\-]+\}/g, m => m.toUpperCase());
        // 前後のアスタリスクを削除（必要なら調整）
        processedText = processedText.replace(/^\*\s*/, '').replace(/\s*\*\s*$/, '');
        // 辞書置換
        for (const key in replaceDict) {
            const pattern = new RegExp(escapeRegExp(key), 'gi');
            const newText = processedText.replace(pattern, (match) => {
                replacementsCount++;
                return replaceDict[key];
            });
            if (newText !== processedText) {
                processedText = newText;
            }
        }
        // 正規表現置換
        for (const rule of regexRules) {
            const newText = processedText.replace(rule.pattern, (match) => {
                // 変更があった場合のみカウント
                if (match !== rule.replacement) {
                    replacementsCount++;
                }
                return rule.replacement;
            });
            if (newText !== processedText) {
                processedText = newText;
            }
        }
        return processedText;
    }

    /**
     * 任意の値（文字列・配列・オブジェクト）を再帰的に処理する
     * 文字列は normalizeTags に渡す
     */
    function deepProcess(value) {
        if (typeof value === 'string') {
            return normalizeTags(value);
        }
        if (Array.isArray(value)) {
            return value.map(v => deepProcess(v));
        }
        if (value && typeof value === 'object') {
            // 新しいオブジェクトを作る（不変性を保つ）
            const out = Array.isArray(value) ? [] : {};
            for (const k in value) {
                if (Object.prototype.hasOwnProperty.call(value, k)) {
                    out[k] = deepProcess(value[k]);
                }
            }
            return out;
        }
        return value;
    }

    function resetUI() {
        fileNameEl.textContent = 'ファイルが選択されていません';
        processBtn.disabled = true;
        messageBox.style.display = 'none';
        dlTranslator.style.display = 'none';
        dlNormal.style.display = 'none';
        uploadedData = null;
        processedTranslator = null;
        processedNormal = null;
        uploadedFileName = 'output';
        // revoke previous URLs just in case
        if (lastTranslatorURL) {
            URL.revokeObjectURL(lastTranslatorURL);
            lastTranslatorURL = null;
        }
        if (lastNormalURL) {
            URL.revokeObjectURL(lastNormalURL);
            lastNormalURL = null;
        }
        originalPreview.textContent = 'ファイルを選択して下さい...';
        processedPreview.textContent = '処理後にここに表示されます。';
        previewContainer.style.display = 'none';
    }
    // ファイル選択イベント
    fileUpload.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) {
            resetUI();
            return;
        }
        uploadedFileName = (file.name || 'output').replace(/\.json$/i, '') || 'output';
        fileNameEl.textContent = file.name;
        processBtn.disabled = false;
        messageBox.style.display = 'none';
        const reader = new FileReader();
        reader.onload = evt => {
            try {
                uploadedData = JSON.parse(evt.target.result);
                originalPreview.textContent = JSON.stringify(uploadedData, null, 2);
                previewContainer.style.display = 'flex';
                showMessage('ファイルが読み込まれました。処理ボタンを押してください。', 'info');
            } catch (err) {
                uploadedData = null;
                processBtn.disabled = true;
                showMessage('JSONの解析に失敗しました。正しいJSONファイルを選択してください。', 'error');
                console.error(err);
            }
        };
        reader.readAsText(file);
    });
    // ドラッグ＆ドロップイベント
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileUploadArea.addEventListener(eventName, preventDefaults, false);
    });
    fileUploadArea.addEventListener('dragenter', () => fileUploadArea.classList.add('dragover'), false);
    fileUploadArea.addEventListener('dragleave', () => fileUploadArea.classList.remove('dragover'), false);
    fileUploadArea.addEventListener('drop', handleDrop, false);
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    function handleDrop(e) {
        fileUploadArea.classList.remove('dragover');
        const dt = e.dataTransfer;
        if (!dt || !dt.files || !dt.files[0]) return;
        const file = dt.files[0];
        // データを file input にセットして change を発火
        fileUpload.files = dt.files;
        fileUpload.dispatchEvent(new Event('change'));
    }
    // 変換処理
    processBtn.addEventListener('click', () => {
        if (!uploadedData) {
            showMessage('先にJSONファイルをアップロードしてください。', 'error');
            return;
        }
        processBtn.disabled = true;
        showMessage('処理中...', 'info');
        // 少し遅延を入れてUIが更新されるようにする
        setTimeout(() => {
            try {
                // deep copy
                const dataCopy = JSON.parse(JSON.stringify(uploadedData));
                // reset counter
                replacementsCount = 0;
                const hasLocale = dataCopy.Locale !== undefined || dataCopy.locale !== undefined;
                const entriesKey = dataCopy.Entries ? 'Entries' : (dataCopy.entries ? 'entries' : null);
                const entries = entriesKey ? dataCopy[entriesKey] : null;
                if (hasLocale && Array.isArray(entries)) {
                    // Sims4Translator 形式（{ Locale, Entries: [{ Key, Value }, ...] }）
                    const replacedEntries = entries.map(entry => {
                        const origKey = entry.Key || entry.key || '';
                        const processedKey = (origKey || '').toUpperCase();
                        const rawValue = entry.Value !== undefined ? entry.Value : entry.value;
                        return {
                            Key: processedKey,
                            Value: deepProcess(rawValue === undefined ? '' : rawValue)
                        };
                    });
                    processedTranslator = { Locale: dataCopy.Locale || dataCopy.locale || 'JPN_JP', Entries: replacedEntries };
                    processedNormal = replacedEntries.map(e => ({ key: e.Key.toLowerCase(), value: e.Value }));
                } else if (Array.isArray(dataCopy)) {
                    // 通常のJSON配列形式 [{ Key/ key, Value / value }, ...]
                    processedTranslator = null;
                    processedNormal = dataCopy.map(entry => {
                        const origKey = entry.Key || entry.key || '';
                        const rawValue = entry.Value !== undefined ? entry.Value : entry.value;
                        return { key: (origKey || '').toLowerCase(), value: deepProcess(rawValue === undefined ? '' : rawValue) };
                    });
                } else if (dataCopy && typeof dataCopy === 'object' && Object.keys(dataCopy).length > 0 && Array.isArray(dataCopy.Entries ?? dataCopy.entries)) {
                    // 念のためのフォールバック
                    const arr = dataCopy.Entries ?? dataCopy.entries;
                    const replacedEntries = arr.map(entry => {
                        const origKey = entry.Key || entry.key || '';
                        const rawValue = entry.Value !== undefined ? entry.Value : entry.value;
                        return {
                            Key: (origKey || '').toUpperCase(),
                            Value: deepProcess(rawValue === undefined ? '' : rawValue)
                        };
                    });
                    processedTranslator = { Locale: dataCopy.Locale || dataCopy.locale || 'JPN_JP', Entries: replacedEntries };
                    processedNormal = replacedEntries.map(e => ({ key: e.Key.toLowerCase(), value: e.Value }));
                } else {
                    throw new Error('非対応のJSON形式です。配列または { Locale, Entries } 形式のいずれかを指定してください。');
                }
                // download 用 Blob を作成し、以前の URL を破棄
                if (lastTranslatorURL) { URL.revokeObjectURL(lastTranslatorURL); lastTranslatorURL = null; }
                if (lastNormalURL) { URL.revokeObjectURL(lastNormalURL); lastNormalURL = null; }
                if (processedTranslator) {
                    const blobT = new Blob([JSON.stringify(processedTranslator, null, 2)], { type: 'application/json' });
                    lastTranslatorURL = URL.createObjectURL(blobT);
                    dlTranslator.href = lastTranslatorURL;
                    dlTranslator.download = `${uploadedFileName}-translator.json`;
                    dlTranslator.style.display = 'flex';
                } else {
                    dlTranslator.style.display = 'none';
                }
                if (processedNormal) {
                    const blobN = new Blob([JSON.stringify(processedNormal, null, 2)], { type: 'application/json' });
                    lastNormalURL = URL.createObjectURL(blobN);
                    dlNormal.href = lastNormalURL;
                    dlNormal.download = `${uploadedFileName}-normal.json`;
                    dlNormal.style.display = 'flex';
                } else {
                    dlNormal.style.display = 'none';
                }
                processedPreview.textContent = JSON.stringify(processedTranslator || processedNormal, null, 2);
                showMessage(`処理が完了しました。置換箇所: ${replacementsCount} 箇所。ダウンロードボタンから保存できます。`, 'success');
            } catch (err) {
                console.error(err);
                showMessage('エラーが発生しました: ' + (err && err.message ? err.message : String(err)), 'error');
                dlTranslator.style.display = 'none';
                dlNormal.style.display = 'none';
            } finally {
                processBtn.disabled = false;
            }
        }, 80);
    });
    // ページ離脱時に作成した ObjectURL を破棄
    window.addEventListener('unload', () => {
        if (lastTranslatorURL) URL.revokeObjectURL(lastTranslatorURL);
        if (lastNormalURL) URL.revokeObjectURL(lastNormalURL);
    });
</script>
</body>
</html>
